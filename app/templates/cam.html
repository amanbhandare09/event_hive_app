{% extends "base.html" %}

{% block title %}QR Scanner | EventHub{% endblock %}

{% block extra_css %}
<style>
    /* Global Background (Inherited from base) */
    body {
        min-height: 100vh;
        /* Ensures the background remains light if base body is styled */
        background: var(--body-background) !important; 
    }

    /* --- Scanner Container (Main Card) --- */
    .scanner-container {
        max-width: 600px;
        margin: 40px auto;
        padding: 2rem;
        /* White Card */
        background: var(--card-background); /* #ffffff */
        border-radius: 12px;
        /* Blue Shadow */
        box-shadow: 0 4px 20px rgba(0, 123, 255, 0.1);
        border: 1px solid var(--event-card-border);
        color: var(--primary-text);
    }

    .scanner-header {
        text-align: center;
        margin-bottom: 1.5rem;
        position: relative;
    }

    .scanner-header h1 {
        /* Primary Blue */
        color: var(--primary-blue);
        margin-bottom: 0.5rem;
        font-size: 26px;
        font-weight: 700;
    }

    /* --- Back Button (Top Left) --- */
    .back-button {
        position: absolute;
        left: 0;
        top: 0;
        background: white;
        border: 2px solid var(--primary-blue);
        color: var(--primary-blue);
        font-size: 16px;
        cursor: pointer;
        padding: 8px 16px;
        border-radius: 8px;
        transition: 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.15);
    }

    .back-button:hover {
        background: var(--primary-blue);
        color: white;
        transform: translateX(-3px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.25);
    }

    .back-button span {
        font-size: 14px;
        font-weight: 600;
    }

    /* --- Event Info Block --- */
    .event-info {
        /* Light Blue Background */
        background: var(--hover-light-blue);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        border-left: 4px solid var(--primary-blue);
    }

    .event-info h3 {
        color: var(--primary-blue);
        margin: 0 0 0.5rem 0;
        font-size: 18px;
    }

    .event-info p {
        margin: 0;
        color: var(--secondary-grey-text);
        font-size: 14px;
    }

    /* --- Video Feed Styling --- */
    #video {
        width: 100%;
        max-width: 500px;
        margin: 15px auto 5px; /* Reduced top margin */
        display: block;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 123, 255, 0.2);
        border: 2px solid var(--primary-blue);
    }

    .controls {
        text-align: center;
        margin-bottom: 1rem;
    }

    /* --- Buttons --- */
    .btn {
        padding: 10px 25px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        border: none;
        cursor: pointer;
        margin: 0 5px;
        transition: 0.3s;
    }

    .btn-primary {
        background: var(--primary-blue);
        color: white;
    }

    .btn-primary:hover {
        background: var(--primary-dark-blue);
    }

    .btn-stop {
        background: #dc3545; /* Error Red Button */
        color: #fff;
    }

    .btn-stop:hover {
        background: #b52a36;
    }
    
    /* --- Result Feedback Area (Enhanced) --- */
    #result {
        margin-top: 10px;
        padding: 1.2rem;
        background: var(--hover-light-blue);
        border-radius: 8px;
        font-size: 16px;
        word-wrap: break-word;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        border: 1px solid var(--navbar-border);
        color: var(--primary-text);
        font-weight: 500;
        margin-bottom: 1rem;
    }

    #result.success {
        background: #d4edda; /* Success Green */
        border-color: #155724;
        color: #155724;
        font-weight: 700;
    }

    #result.error {
        background: #f8d7da; /* Error Red */
        border-color: #721c24;
        color: #721c24;
        font-weight: 700;
    }

    #result.warning {
        background: #fff3cd; /* Warning Yellow */
        border-color: #856404;
        color: #856404;
        font-weight: 700;
    }

    /* --- Stats Section (Grid Layout) --- */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr); /* Fixed 3 columns */
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .stat-card {
        background: var(--hover-light-blue);
        padding: 0.8rem;
        border-radius: 8px;
        text-align: center;
        border: 1px solid var(--navbar-border);
    }

    .stat-card h4 {
        color: var(--primary-blue);
        margin: 0 0 0.2rem 0;
        font-size: 20px;
        font-weight: 700;
    }

    .stat-card p {
        margin: 0;
        color: var(--secondary-grey-text);
        font-size: 12px;
    }

    /* --- Scan Indicator --- */
    .scan-indicator {
        text-align: center;
        margin: 0.5rem 0;
        font-size: 14px;
        color: var(--secondary-grey-text);
    }

    .scan-indicator.active {
        color: var(--primary-blue);
        font-weight: 600;
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .back-link {
        display: inline-block;
        margin-top: 2rem;
        color: var(--primary-blue);
        text-decoration: none;
        font-size: 14px;
    }

    .back-link:hover {
        text-decoration: underline;
    }

    @media (max-width: 768px) {
        .scanner-container {
            margin: 20px;
            padding: 1.5rem;
        }

        .scanner-header {
            padding-top: 30px;
        }

        .back-button {
            font-size: 20px;
        }

        .back-button span {
            display: none;
        }

        .stats-container {
            grid-template-columns: 1fr;
        }

        .stat-card {
            padding: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}

<div class="scanner-container">
    
    <div class="scanner-header">
        <button class="back-button" onclick="goBack()">
            ‚Üê <span>Back</span>
        </button>
        <h1>üì∑ QR Code Scanner</h1>
        <p style="color: var(--secondary-grey-text);">Managing Check-ins for: {{ event.title }}</p>
    </div>

    <div class="controls">
        <button class="btn btn-primary" onclick="startCamera()" id="startBtn">
            Start Camera
        </button>
        <button class="btn btn-stop" onclick="stopCamera()" id="stopBtn" style="display: none;">
            Stop Camera
        </button>
    </div>

    <div class="scan-indicator" id="scanIndicator">
        Ready to scan...
    </div>

    <video id="video" autoplay playsinline style="display: none;"></video>

    <div id="result">Waiting to start scanner...</div>

    <div class="stats-container">
        <div class="stat-card">
            <h4 id="scannedCount">0</h4>
            <p>Scans Attempted</p>
        </div>
        <div class="stat-card">
            <h4 id="successCount">0</h4>
            <p>Successful Check-ins</p>
        </div>
        <div class="stat-card">
            <h4 id="errorCount">0</h4>
            <p>Errors/Duplicates</p>
        </div>
    </div>

    <div style="text-align: center;">
        <a href="{{ url_for('attendees.get_attendee', event_id=event.id) }}" class="back-link">
            ‚Üê Back to Attendees List
        </a>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

<script>
    let video = document.getElementById("video");
    let canvas = document.createElement("canvas");
    let context = canvas.getContext("2d");
    let isScanning = false;
    let lastScannedCode = null;
    let lastScanTime = 0;
    
    // Stats
    let scannedCount = 0;
    let successCount = 0;
    let errorCount = 0;

    const EVENT_ID = {{ event.id }};

    // Back button function
    function goBack() {
        // Stop camera before navigating back
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
        }
        
        // Use browser history to go back to previous page
        window.history.back();
    }

    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" } 
            });
            
            video.srcObject = stream;
            video.style.display = "block";
            isScanning = true;

            // Update UI
            document.getElementById("startBtn").style.display = "none";
            document.getElementById("stopBtn").style.display = "inline-block";
            document.getElementById("scanIndicator").classList.add("active");
            document.getElementById("scanIndicator").innerText = "üîç Scanning for QR codes...";
            document.getElementById("result").className = "";
            document.getElementById("result").innerText = "Point camera at QR code...";

            // Start scanning loop
            scanLoop();
        } catch (err) {
            showResult("‚ùå Camera access denied. Please allow camera permissions.", "error");
            console.error(err);
        }
    }

    function stopCamera() {
        isScanning = false;
        
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
        }
        
        video.style.display = "none";
        
        // Update UI
        document.getElementById("startBtn").style.display = "inline-block";
        document.getElementById("stopBtn").style.display = "none";
        document.getElementById("scanIndicator").classList.remove("active");
        document.getElementById("scanIndicator").innerText = "Camera stopped";
        showResult("Camera stopped. Click 'Start Camera' to scan again.", "");
    }

    function scanLoop() {
        if (!isScanning) return;
        
        requestAnimationFrame(scanLoop);

        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const qrCode = jsQR(imageData.data, imageData.width, imageData.height);

            if (qrCode) {
                const currentTime = Date.now();
                
                // Prevent duplicate scans (wait 3 seconds between scans of same code)
                if (lastScannedCode === qrCode.data && (currentTime - lastScanTime) < 3000) {
                    return;
                }
                
                lastScannedCode = qrCode.data;
                lastScanTime = currentTime;
                
                processQRCode(qrCode.data);
            }
        }
    }

    async function processQRCode(qrData) {
        scannedCount++;
        updateStats();
        
        try {
            // Parse QR code data
            const data = JSON.parse(qrData);
            
            showResult("‚è≥ Processing QR code...", "warning");
            
            // Validate QR data has required fields
            if (!data.attendee_id || !data.event_id || !data.user_id || !data.token) {
                throw new Error("Invalid QR code format - missing required fields");
            }
            
            // Verify QR is for current event
            if (data.event_id != EVENT_ID) {
                throw new Error("This QR code is for a different event!");
            }
            
            // Send to server to mark attendance
            const response = await fetch('/mark-attendance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            
            console.log("Server Response:", result); // Debug log

            if (response.ok && result.success) {
                successCount++;
                updateStats();
                
                if (result.already_marked) {
                    showResult(`‚ö†Ô∏è ${result.message}`, "warning");
                } else {
                    showResult(`‚úÖ ${result.message}`, "success");
                    
                    // Play success sound (optional)
                    playBeep(800, 200);
                }
            } else {
                errorCount++;
                updateStats();
                showResult(`‚ùå Error: ${result.error || 'Unknown error'}`, "error");
                console.error("API Error:", result); // Debug log
                playBeep(400, 400); // Error sound
            }

        } catch (error) {
            errorCount++;
            updateStats();
            console.error("QR Processing Error:", error);
            showResult(`‚ùå ${error.message || 'Invalid QR code or processing error'}`, "error");
            playBeep(400, 400);
        }
    }

    function showResult(message, className) {
        const resultDiv = document.getElementById("result");
        resultDiv.innerText = message;
        resultDiv.className = className;
    }

    function updateStats() {
        document.getElementById("scannedCount").innerText = scannedCount;
        document.getElementById("successCount").innerText = successCount;
        document.getElementById("errorCount").innerText = errorCount;
    }

    // Optional: Play beep sound for feedback
    function playBeep(frequency, duration) {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration / 1000);
        } catch (e) {
            // Audio not supported or blocked
            console.log("Audio feedback not available");
        }
    }

    // Stop camera when leaving page
    window.addEventListener('beforeunload', () => {
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
        }
    });
</script>

{% endblock %}