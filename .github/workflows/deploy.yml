name: Deploy EventHive App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
          echo "SSH setup complete"

      - name: Create .env file
        run: |
          cat > .env << EOF
          FLASK_ENV=${{ secrets.FLASK_ENV || 'production' }}
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          FLASK_APP=app

          SQLALCHEMY_DATABASE_URI=${{ secrets.SQLALCHEMY_DATABASE_URI }}
          EOF

      - name: Copy application to EC2 via rsync
        run: |
          rsync -avz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='venv' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:/home/ubuntu/eventhive-deploy/

      - name: Deploy application on EC2
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
            echo "===== STARTING DEPLOY ====="

            cd /home/ubuntu/eventhive-deploy

            echo "===== DOCKER SETUP ====="
            if ! command -v docker &> /dev/null; then
              sudo apt update
              sudo apt install -y docker.io
              sudo systemctl enable docker
              sudo usermod -aG docker $USER
            fi

            echo "===== STOP OLD CONTAINER ====="
            docker stop myapp || true
            docker rm myapp || true

            echo "===== BUILD NEW DOCKER IMAGE ====="
            docker build -t myapp:latest .

            echo "===== RUN CONTAINER ====="
            docker run -d --name myapp -p 80:5000 myapp:latest

            echo "===== DEPLOYMENT DONE ====="
          EOF

      - name: Health Check
        run: |
          echo "Waiting for container to start..."
          sleep 10
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.EC2_HOST }} || echo "000")
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "Deployment SUCCESS! HTTP status: $HTTP_CODE"
          else
            echo "âš  Deployment FAILED! HTTP status: $HTTP_CODE"
            exit 1
          fi

      - name: Clean up SSH key
        if: always()
        run: rm -f ~/.ssh/id_rsa
