name: Deploy Flask App to EC2 (No Docker)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. Pull code from GitHub
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. Setup SSH private key
    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

    # 3. Add EC2 host to known hosts
    - name: Add EC2 to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    # 4. Upload project to EC2 (replaces old folder)
    - name: Upload project to EC2
      run: |
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
        ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} "rm -rf ~/app && mkdir ~/app"

        scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -r ./* \
        ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:~/app/

    # 5. Install dependencies & restart Flask/Gunicorn on EC2
    - name: Restart EC2 App
      run: |
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
        ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} "
          cd ~/app &&
          python3 -m venv venv &&
          source venv/bin/activate &&
          pip install -r requirements.txt
          sudo systemctl restart flaskapp
        "
