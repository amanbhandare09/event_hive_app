- name: Deploy to EC2
  uses: appleboy/ssh-action@v1.2.0
  with:
    host: ${{ secrets.EC2_HOST }}
    username: ${{ secrets.EC2_USER }}
    key: ${{ secrets.EC2_SSH_KEY }}
    script: |
      # ===============================
      # Install Docker if not installed
      # ===============================
      if ! command -v docker &> /dev/null
      then
          echo "ğŸ‹ Installing Docker..."
          sudo apt update
          sudo apt install -y docker.io
          sudo systemctl start docker
          sudo systemctl enable docker
          sudo usermod -aG docker $USER
      else
          echo "ğŸ‹ Docker already installed."
      fi

      # ===============================
      # Create app directory if missing
      # ===============================
      if [ ! -d "/home/ubuntu/myapp" ]; then
          echo "ğŸ“ Creating project directory..."
          mkdir -p /home/ubuntu/myapp
      fi

      cd /home/ubuntu/myapp

      # ===============================
      # If .git missing â†’ clone repo
      # ===============================
      if [ ! -d ".git" ]; then
          echo "ğŸ”„ Cloning repository..."
          git clone https://github.com/YOUR_USERNAME/YOUR_REPO.git .
      else
          echo "ğŸ“¥ Pulling latest changes..."
          git pull origin main
      fi

      # ===============================
      # Build and restart Docker
      # ===============================
      echo "ğŸ›‘ Stopping old container..."
      docker compose down || true

      echo "ğŸ”¨ Building new image..."
      docker compose build --no-cache

      echo "ğŸš€ Starting container..."
      docker compose up -d

      echo "ğŸ‰ Deployment successful!"
